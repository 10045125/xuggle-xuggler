Index: libavformat/utils.c
===================================================================
--- libavformat/utils.c	(revision 19398)
+++ libavformat/utils.c	(working copy)
@@ -499,7 +499,9 @@
     av_freep(&pd->buf);
     if (pb)
         url_fclose(pb);
-    av_freep(ic_ptr);
+    if (ap && ap->prealloced_context)
+      av_free(*ic_ptr);
+    *ic_ptr = NULL;
     return err;
 
 }

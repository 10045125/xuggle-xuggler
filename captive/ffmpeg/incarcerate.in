#!/bin/sh

# Modify this script to pass the necessary parameters to 
# the configure of the captive package you're configuring
prefix="@prefix@"
exec_prefix="@exec_prefix@"
HOST_TYPE=@HOST_TYPE@
HOST_OS=@HOST_OS@
HOST_CPU=@HOST_CPU@
HOST_VENDOR=@HOST_VENDOR@
HOST_OS_C=@HOST_OS_C@

VS_DEBUG=@VS_DEBUG@

CAPTIVE_ENABLE_FFMPEG_GPL=@VS_ENABLE_GPL@

SVN_REVISION=`@abs_top_srcdir@/revision.sh @abs_top_srcdir@ @abs_top_srcdir@/LastRevisionBuilt.txt @abs_top_srcdir@/LastRevisionBuild.txt`

FFMPEG_OPTIONS=
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --extra-version=xuggle-@LIB_MAJOR_VERSION@.@LIB_MINOR_VERSION@.${SVN_REVISION}"

# Tell FFMPEG about the captive libraries already built and fake
# installed
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --extra-cflags=-I@abs_top_builddir@@includedir@"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --extra-ldflags=-L@abs_top_builddir@@libdir@"
# Set up a place where pkg-config looks for installed packages
export PKG_CONFIG_PATH="@abs_top_builddir@@libdir@/pkgconfig"

FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-shared"
#FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-runtime-cpudetect"

if test "x$CAPTIVE_ENABLE_FFMPEG_GPL" = "xyes"; then
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-gpl --enable-nonfree"
  # x264 can only be used in GPL mode
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-libx264"
fi
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-version3"

if [ "@VS_CROSS_COMPILE@" = "1" ]; then
  FFMPEG_OPTIONS="${FFMPEG_OPTIONS} --enable-cross-compile --cross-prefix=${HOST_OS}- --arch=${HOST_CPU} --target-os=${HOST_OS_C}"
  # Override the cross setting for PKG-CONFIG since that is not usually set up to
  # be cross-compile friendly
  if ! "${HOST_OS}-pkg-config" --version > /dev/null 2>&1; then
    # default to pkg-config WITHOUT a prefix; we don't really care since
    # we're faking out pkg-config anyway
    FFMPEG_OPTIONS="$FFMPEG_OPTIONS --pkg-config=pkg-config"
  fi
fi

if test ! "x$VS_DEBUG" = "x"; then
  echo "Creating debug version of ffmpeg: $VS_DEBUG"
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --disable-stripping"
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --disable-asm"
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --disable-optimizations"
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --disable-mmx"
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --disable-mmx2"
else
  echo "Creating release version of ffmpeg: $VS_DEBUG"
fi
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-libmp3lame"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-libvorbis"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-libtheora"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-libspeex"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-libvo-aacenc"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-libopencore-amrnb --enable-libopencore-amrwb"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-librtmp"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-openssl"
FFMPEG_OPTIONS="$FFMPEG_OPTIONS --enable-zlib"

case $HOST_OS in
  *cygwin*)
  CC="${CC} -mno-cygwin"
  LDFLAGS="$LDFLAGS -mno-cygwin"
  ;;
  *darwin*)
# Mac OS X Lion ships uses llvm to link and ffmpeg doesn't play nice
# So we force clang as the compiler
  FFMPEG_OPTIONS="$FFMPEG_OPTIONS --cc=clang"
  ;;
  *)
  ;;
esac

echo "Configuring FFMPEG with these options: $FFMPEG_OPTIONS"
cd @abs_builddir@/csrc
PATH="$PATH:@abs_top_builddir@@bindir@@" sh @abs_srcdir@/csrc/configure \
  --prefix="${prefix}" $FFMPEG_OPTIONS || \
  (echo "Could not configure library: \"@abs_srcdir@\"; you may want to try disabling it or installing your own version" && exit 1)
